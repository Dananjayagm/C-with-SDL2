#include <SDL2/SDL.h>
#include <vector>
#include <emscripten.h> // ‚Üê REQUIRED for browser execution

const int WIDTH = 600;
const int HEIGHT = 600;
const int GRID = 20;

struct Point {
int x, y;
};

// Make variables global so they persist between frames
SDL_Window* window;
SDL_Renderer* renderer;
std::vector<Point> snake;
Point food;
int dx = GRID, dy = 0;
Uint32 lastMove = 0;
bool running = true;

void main_loop() {
SDL_Event event;

// 1. Handle events (this runs every frame)
while (SDL_PollEvent(&event)) {
if (event.type == SDL_QUIT) {
running = false;
emscripten_cancel_main_loop(); // Stop the browser loop
}

if (event.type == SDL_KEYDOWN) {
switch (event.key.keysym.sym) {
case SDLK_LEFT: if (dx == 0) { dx = -GRID; dy = 0; } break;
case SDLK_RIGHT: if (dx == 0) { dx = GRID; dy = 0; } break;
case SDLK_UP: if (dy == 0) { dy = -GRID; dx = 0; } break;
case SDLK_DOWN: if (dy == 0) { dy = GRID; dx = 0; } break;
}
}
}

// 2. Update game state (only every 120ms for consistent speed)
Uint32 now = SDL_GetTicks();
if (now - lastMove > 120) {
lastMove = now;

Point newHead = snake[0];
newHead.x += dx;
newHead.y += dy;

// Wrap around
if (newHead.x < 0) newHead.x = WIDTH - GRID;
if (newHead.x >= WIDTH) newHead.x = 0;
if (newHead.y < 0) newHead.y = HEIGHT - GRID;
if (newHead.y >= HEIGHT) newHead.y = 0;

snake.insert(snake.begin(), newHead);

if (newHead.x == food.x && newHead.y == food.y) {
food.x = (rand() % (WIDTH / GRID)) * GRID;
food.y = (rand() % (HEIGHT / GRID)) * GRID;
} else {
snake.pop_back();
}

// 3. Render
SDL_SetRenderDrawColor(renderer, 20, 20, 20, 255);
SDL_RenderClear(renderer);

// Draw snake
for (auto& s : snake) {
SDL_Rect r = { s.x, s.y, GRID, GRID };
SDL_SetRenderDrawColor(renderer, 0, 255, 0, 255);
SDL_RenderFillRect(renderer, &r);
}

// Draw food
SDL_Rect f = { food.x, food.y, GRID, GRID };
SDL_SetRenderDrawColor(renderer, 255, 0, 0, 255);
SDL_RenderFillRect(renderer, &f);

SDL_RenderPresent(renderer);
}
}

int main() {
SDL_Init(SDL_INIT_VIDEO);

window = SDL_CreateWindow("Snake WASM",
SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED,
WIDTH, HEIGHT, SDL_WINDOW_SHOWN);

renderer = SDL_CreateRenderer(window, -1, 0);

// Initialize snake in middle
snake = { {WIDTH / 2, HEIGHT / 2} };

// Initialize first food
food = { 200, 200 };

// Seed random for food placement
srand(SDL_GetTicks());

// THE KEY FIX: Use Emscripten's browser-friendly main loop
// This calls main_loop() repeatedly without blocking the browser
emscripten_set_main_loop(main_loop, 0, 1);

// Note: We don't return here - the loop runs until cancelled
return 0;
}
